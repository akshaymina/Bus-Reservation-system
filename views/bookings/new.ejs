<%- include('../partials/header') %>

<div class="container mt-4" 
     data-bus-fare="<%= bus.fare %>" 
     data-max-passengers="<%= passengers %>" 
     data-seat-layout="<%- JSON.stringify(seatLayout) %>">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1>Book Bus</h1>
        </div>
    </div>

    <div class="row">
        <!-- Bus Information -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title"><%= bus.busName %></h5>
                    <h6 class="card-subtitle mb-3 text-muted"><%= bus.busNumber %> - <%= bus.busType %></h6>
                    
                    <div class="mb-3">
                        <p><strong>From:</strong> <%= bus.source %></p>
                        <p><strong>To:</strong> <%= bus.destination %></p>
                        <p><strong>Departure:</strong> <%= bus.formattedDepartureTime %></p>
                        <p><strong>Arrival:</strong> <%= bus.formattedArrivalTime %></p>
                    </div>

                    <div class="mb-3">
                        <p><strong>Available Seats:</strong> <%= bus.totalSeats - bus.bookedSeats %></p>
                        <p><strong>Fare per Seat:</strong> ₹<%= bus.fare %></p>
                        <p><strong>Duration:</strong> <%= bus.duration %> hours</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seat Selection -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Select Seats</h5>
                    <p class="text-muted">Click on available seats to select them.</p>

                    <div class="seat-layout mt-3">
                        <% for(let row = 1; row <= Math.ceil(bus.totalSeats / 4); row++) { %>
                            <div class="seat-row">
                                <% for(let col = 1; col <= 4; col++) { %>
                                    <% const seatNumber = (row - 1) * 4 + col; %>
                                    <% if (seatNumber <= bus.totalSeats) { %>
                                        <% const seatStatus = seatLayout[seatNumber] || 'available'; %>
                                        <div class="seat <%= seatStatus %>" 
                                             data-seat-number="<%= seatNumber %>"
                                             data-bs-toggle="tooltip"
                                             data-bs-placement="top"
                                             title="<%= seatStatus === 'available' ? 'Click to select' : 'Not available' %>">
                                            <%= seatNumber %>
                                        </div>
                                    <% } %>
                                <% } %>
                            </div>
                        <% } %>
                    </div>

                    <div class="mt-4">
                        <div class="d-flex gap-3 mb-3">
                            <div class="seat-legend">
                                <div class="seat available"></div>
                                <span>Available</span>
                            </div>
                            <div class="seat-legend">
                                <div class="seat selected"></div>
                                <span>Selected</span>
                            </div>
                            <div class="seat-legend">
                                <div class="seat booked"></div>
                                <span>Booked</span>
                            </div>
                        </div>
                        <p><strong>Selected Seats:</strong> <span id="selectedSeatsCount">0</span></p>
                        <p><strong>Total Amount:</strong> ₹<span id="totalAmount">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Passenger Details Form -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Passenger Details</h5>
                    <form id="bookingForm" action="/bookings" method="POST" class="needs-validation" novalidate>
                        <input type="hidden" name="busId" value="<%= bus.id %>">
                        <input type="hidden" name="seats" id="selectedSeats">
                        <input type="hidden" name="passengerDetails" id="passengerDetails">

                        <div id="passengerForms">
                            <!-- Passenger forms will be dynamically added here -->
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary" id="submitBooking" disabled>
                                Proceed to Payment
                            </button>
                            <a href="/buses/search?source=<%= bus.source %>&destination=<%= bus.destination %>&date=<%= date %>&passengers=<%= passengers %>" 
                               class="btn btn-secondary">Back to Search</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.seat-layout {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    max-width: 600px;
    margin: 0 auto;
}

.seat-row {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
}

.seat {
    width: 45px;
    height: 45px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.3s ease;
    border: 2px solid #ccc;
}

.seat.available {
    background-color: #ffffff;
    color: #333;
    border-color: #28a745;
}

.seat.available:hover {
    background-color: #e8f5e9;
    transform: scale(1.05);
}

.seat.selected {
    background-color: #28a745;
    color: white;
    border-color: #1e7e34;
}

.seat.booked {
    background-color: #dc3545;
    color: white;
    border-color: #bd2130;
    cursor: not-allowed;
    opacity: 0.7;
}

/* Aisle styling */
.seat-row .col-3:nth-child(2) {
    margin-right: 20px; /* Creates an aisle after the second seat */
}

.seat-legend {
    display: flex;
    align-items: center;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
    padding: 10px;
    background: white;
    border-radius: 8px;
}

.seat-legend .seat {
    width: 35px;
    height: 35px;
    margin: 0;
}

.seat-legend span {
    font-size: 14px;
}
</style>

<script>
$(document).ready(function() {
    const selectedSeats = new Set();
    const container = $('.container');
    const baseFare = parseFloat(container.data('busFare'));
    const seatLayout = JSON.parse(container.data('seatLayout'));
    const maxPassengers = parseInt(container.data('maxPassengers'));

    // Initialize tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Handle seat selection
    $('.seat').not('.booked').on('click', function() {
        const seatNumber = $(this).data('seatNumber');
        
        if ($(this).hasClass('selected')) {
            // Deselect seat
            $(this).removeClass('selected').addClass('available');
            selectedSeats.delete(seatNumber);
        } else if (selectedSeats.size < maxPassengers) {
            // Select seat
            $(this).removeClass('available').addClass('selected');
            selectedSeats.add(seatNumber);
        } else {
            alert(`You can only select ${maxPassengers} seat(s)`);
            return;
        }
        
        updateUI();
    });

    function updateUI() {
        // Update seat count and total amount
        const count = selectedSeats.size;
        $('#selectedSeatsCount').text(count);
        $('#totalAmount').text((count * baseFare).toLocaleString('en-IN'));
        
        // Update hidden input for form submission
        $('#selectedSeats').val(JSON.stringify(Array.from(selectedSeats)));
        
        // Enable/disable submit button based on selection
        $('#submitBooking').prop('disabled', count === 0 || count !== maxPassengers);

        // Update passenger forms
        updatePassengerForms();
    }

    function updatePassengerForms() {
        const container = $('#passengerForms');
        container.empty();
        
        Array.from(selectedSeats).forEach((seatNumber, index) => {
            const form = $('<div>').addClass('card mb-3');
            form.html(`
                <div class="card-body">
                    <h6 class="card-title">Passenger ${index + 1} - Seat ${seatNumber}</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control passenger-name" data-seat="${seatNumber}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Age</label>
                            <input type="number" class="form-control passenger-age" data-seat="${seatNumber}" min="1" max="120" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Gender</label>
                            <select class="form-select passenger-gender" data-seat="${seatNumber}" required>
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control passenger-phone" data-seat="${seatNumber}" required>
                        </div>
                    </div>
                </div>
            `);
            container.append(form);
        });
    }

    // Form submission handler
    $('#bookingForm').on('submit', function(e) {
        e.preventDefault();
        
        if (selectedSeats.size !== maxPassengers) {
            alert(`Please select exactly ${maxPassengers} seat(s)`);
            return;
        }

        // Gather passenger details
        const passengerDetails = Array.from(selectedSeats).map(seatNumber => ({
            seatNumber: parseInt(seatNumber),
            name: $(`.passenger-name[data-seat="${seatNumber}"]`).val(),
            age: parseInt($(`.passenger-age[data-seat="${seatNumber}"]`).val()),
            gender: $(`.passenger-gender[data-seat="${seatNumber}"]`).val(),
            phone: $(`.passenger-phone[data-seat="${seatNumber}"]`).val()
        }));

        $('#passengerDetails').val(JSON.stringify(passengerDetails));
        this.submit();
    });
});
</script>

<%- include('../partials/footer') %> 