<%- include('../partials/header') %>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1>Book Bus</h1>
        </div>
    </div>

    <div class="row">
        <!-- Bus Information -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title"><%= bus.busNumber %></h5>
                    <h6 class="card-subtitle mb-3 text-muted"><%= bus.busType %></h6>
                    
                    <div class="mb-3">
                        <p><strong>From:</strong> <%= bus.source %></p>
                        <p><strong>To:</strong> <%= bus.destination %></p>
                        <p><strong>Departure:</strong> <%= new Date(bus.departureTime).toLocaleString() %></p>
                        <p><strong>Arrival:</strong> <%= new Date(bus.arrivalTime).toLocaleString() %></p>
                    </div>

                    <div class="mb-3">
                        <p><strong>Available Seats:</strong> <%= bus.totalSeats - bus.bookedSeats %></p>
                        <p><strong>Fare per Seat:</strong> ₹<%= bus.fare %></p>
                        <p><strong>Duration:</strong> <%= bus.duration %> hours</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seat Selection -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Select Seats</h5>
                    <p class="text-muted">Click on available seats to select them.</p>

                    <div class="seat-layout mt-3">
                        <% for(let row = 1; row <= Math.ceil(bus.totalSeats / 4); row++) { %>
                            <div class="row mb-2">
                                <% for(let col = 1; col <= 4; col++) { %>
                                    <% const seatNumber = (row - 1) * 4 + col; %>
                                    <% if (seatNumber <= bus.totalSeats) { %>
                                        <% const seatStatus = seatLayout[seatNumber] || 'available'; %>
                                        <div class="col-3">
                                            <div class="seat <%= seatStatus %>" 
                                                 data-seat-number="<%= seatNumber %>"
                                                 data-bs-toggle="tooltip"
                                                 data-bs-placement="top"
                                                 title="<%= seatStatus === 'available' ? 'Click to select' : 'Not available' %>">
                                                Seat <%= seatNumber %>
                                            </div>
                                        </div>
                                    <% } else { %>
                                        <div class="col-3"></div>
                                    <% } %>
                                <% } %>
                            </div>
                        <% } %>
                    </div>

                    <div class="mt-4">
                        <div class="d-flex gap-3 mb-3">
                            <div class="seat-legend">
                                <div class="seat available"></div>
                                <span>Available</span>
                            </div>
                            <div class="seat-legend">
                                <div class="seat selected"></div>
                                <span>Selected</span>
                            </div>
                            <div class="seat-legend">
                                <div class="seat booked"></div>
                                <span>Booked</span>
                            </div>
                        </div>
                        <p><strong>Selected Seats:</strong> <span id="selectedSeatsCount">0</span></p>
                        <p><strong>Total Amount:</strong> ₹<span id="totalAmount">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Passenger Details Form -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Passenger Details</h5>
                    <form id="bookingForm" action="/bookings" method="POST" class="needs-validation" novalidate>
                        <input type="hidden" name="busId" value="<%= bus.id %>">
                        <input type="hidden" name="seats" id="selectedSeats">
                        <input type="hidden" name="passengerDetails" id="passengerDetails">

                        <div id="passengerForms">
                            <!-- Passenger forms will be dynamically added here -->
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary" id="submitBooking" disabled>
                                Proceed to Payment
                            </button>
                            <a href="/buses/<%= bus.id %>" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectedSeats = new Set();
    const baseFare = <%= bus.fare %>;
    const seatLayout = <%- JSON.stringify(seatLayout) %>;

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Handle seat selection
    document.querySelectorAll('.seat.available').forEach(seat => {
        seat.addEventListener('click', function() {
            const seatNumber = this.dataset.seatNumber;
            if (selectedSeats.has(seatNumber)) {
                selectedSeats.delete(seatNumber);
                this.classList.remove('selected');
            } else {
                selectedSeats.add(seatNumber);
                this.classList.add('selected');
            }
            updateSelectedSeats();
            updatePassengerForms();
        });
    });

    function updateSelectedSeats() {
        const count = selectedSeats.size;
        document.getElementById('selectedSeatsCount').textContent = count;
        document.getElementById('totalAmount').textContent = count * baseFare;
        document.getElementById('selectedSeats').value = JSON.stringify([...selectedSeats]);
        document.getElementById('submitBooking').disabled = count === 0;
    }

    function updatePassengerForms() {
        const container = document.getElementById('passengerForms');
        container.innerHTML = '';
        
        selectedSeats.forEach((seatNumber, index) => {
            const formHtml = `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">Passenger ${index + 1} (Seat ${seatNumber})</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control passenger-name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Age</label>
                                <input type="number" class="form-control passenger-age" min="1" max="120" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Gender</label>
                                <select class="form-select passenger-gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Seat Number</label>
                                <input type="text" class="form-control" value="${seatNumber}" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', formHtml);
        });
    }

    // Handle form submission
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
            e.stopPropagation();
            this.classList.add('was-validated');
            return;
        }

        const passengers = [];
        const forms = document.querySelectorAll('.card.mb-3');
        
        forms.forEach(form => {
            passengers.push({
                name: form.querySelector('.passenger-name').value,
                age: form.querySelector('.passenger-age').value,
                gender: form.querySelector('.passenger-gender').value,
                seatNumber: form.querySelector('input[readonly]').value
            });
        });

        document.getElementById('passengerDetails').value = JSON.stringify(passengers);
        this.submit();
    });
});
</script>

<style>
.seat-legend {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.seat-legend .seat {
    width: 30px;
    height: 30px;
    margin: 0;
}
</style>

<%- include('../partials/footer') %> 